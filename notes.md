DATABASE-INTEGRATION
________________________________________________________________________

Krav för G:
- Följ instruktionerna i beskrivningen
- Använd Git för versionshantering
- Använd PostgreSQL som databas

Krav för VG:
- Uppnå alla krav för G
- Spara kontoinformation på ett säkert sätt (hashing av lösenord)
- Använd SQL JOINS för data hämtning när det går
- Använd minst två SQL TRANSACTIONS
- Använd alla normalformer (1NF, 2NF, 3NF)
- Felhantera alla databasoperationer (try/catch, resource releasing, using)


Beskrivning
Fortsätt på Personal Finance projektet från förra kursen. Det är okej att skriva om projektet från scratch om det känns enklare med kommande uppgifter.

Applikationen skall koppla på och använda en databas för att spara och hantera information. Alla transaktioner skall sparas och hämtas och raderas och uppdateras till/från databas. Det skall även finnas ett kontosystem, med vilket man kan logga in på olika användare, byta mellan dem och lägga till transaktioner. All funktionalitet som fanns i uppgiften från förra kursen skall finnas nu, men kan skall kunna göra det per-användare. En användare kan inte se transaktioner för en annan användare.


Förtydligande krav för kontosystem, följande möjligheter skall finnas:
- Registrera användare genom namn och lösenord
- Logga in genom namn och lösenord
- Logga ut (och kunna byta användare genom att logga in igen)
- All funktionalitet från tidigare uppgift, kopplat per-användare

________________________________________________________________________

= EGNA TANKAR INFÖR DENNA UPPGIFT = 

Siktar på att uppnå samtliga krav för VG men vill inte fokusera för mycket tid på just detta projekt då jag vill testa lite egna projekt från grund när jag blir färdig. Därför kommer jag att göra val baserat på vad som faktiskt behövs göras och kanske inte på att förbättra programmet ännu mer. Fokus är på lärande inom ramen för uppgift-specifikationen, inte utanför. 
________________________________________________________________________

= TODO = 

- = Not completed
X = Completed

Database
- Create users table with hashed passwords and timestamps.
- Create transactions table linked to users via foreign key.
- Ensure database normalization (1NF, 2NF, 3NF).

Authentication
- Implement user registration with hashed passwords.
- Implement login functionality (verify password and load user data).
- Implement logout functionality.

Transactions
- Add transactions (CRUD operations).
- Filter and display transactions for the logged-in user only.
- Use SQL JOINs for queries involving multiple tables.

Security
- Hash passwords (e.g. BCrypt?)
Ensure sensitive data like passwords are not logged or exposed.

Error Handling
Wrap all database operations in try-catch blocks.
Log or display meaningful error messages for database issues.
Use using or IDisposable for resource cleanup.


________________________________________________________________________

= QUESTIONS AND CONSIDERATIONS =
Should I have UUID for my user_id and tx_id, or just use SERIAL?
  - SERIAL: Simpler, easier to read, may be more appropriate for my application.
  - UUID: Better security, more common in professional environs, good practice.

Should I explicitly call the reader.Close() instead of just relying on the 'using'?
 - Probably not, unless more complex logic is introduced.

________________________________________________________________________

= DOCUMENTATION =

Saturday, Nov 23 
- Added Npgsql.
- New class DatabaseManager in Services.

- Set up connection specs and constructor for dbManager.
    - sql table creation for users.
- Experimenting with a wrapper method for the NpgsqlCommand.ExecuteNonQuery-method.
    - Unsure how this will work with SQL-injection. Will be mindful.
- Began implementing AddUser method for adding new users to the database.
    Uses SQL RETURNING to retrieve user_id and created_at(?) (generated by the DB)
- Changed User.UserId from string to int (match DB type).

------------------------------------------------------------------------
Monday, Nov 25
DatabaseManager.AddUser():
    - Removed created_at from the RETURNING. Not needed immediately and could retrieve it during other operations. E.g. GetUser() or something.
    - Additional error handling: Guard clause Null/WS and TryCatchThrow

Added try/catch to Main for testing AddUser when resolved errors from changing UserId from string to int.

Refactoring UserService (userId)
    - removed LoadUsers' int parsing
    - removed GenerateUserId method and its calling in CreateAccount.
    - added private readonly field _dbManager

Tested Hardcoded username and password. Works with the database.
Added _dbManager instance to Initialize() - keeping it this way unless it is needed in more places across Program, then I might make it a field.

Added BCrypt
    - Fixed CreateAccount to hash password
    - Fixed AuthenticateUser to check against hashedPassword instead
    - Changed User.cs Password to HashedPassword

------------------------------------------------------------------------
Wednesday, Nov 27
Changes to DatabaseManager:
  Added SQL string for create transaction_type_enum
  Added SQL string for create transactions table
    - Included ON DELETE CASCADE to preserve referential integrity upon deletion of a user.
 
  Isolated each SQL-command to call their own ExecuteNonQuery()
    - Why? Debugging and maintainability.

  Moved the SQL string commands to be initialized as constant fields.
    - Cleaner constructor, better performance, static and immutable.

  Created InitializeDatabase() to further simplify the constructor
    - Executes the SQL commands
    - Added logging messages (only console.writelines)

------------------------------------------------------------------------
Friday, Nov 29

- Added GetUserByUsername() to DatabaseManager for reading users from the DB through a query.

- Adjusted AuthenticateUser to instead of relying on the Dictionary users (loaded from file)

it now uses the above GetUser method to retrieve the user and let BCrypt verify the inputted 
password against the hashed pw.

Improved DatabaseManager class:
- DatabaseManager.AddUser() - changed from ExecuteReader to ExecuteScalar for RETURNING user_id (single value).
- Implemented IDisposable + added dispose() method.

------------------------------------------------------------------------
Saturday, Nov 30
Changed transaction.cs TransactionId from string to int to match database. Simplicity.
Started working on DatabaseTransactionStorage's LoadTransactionsAsync.

------------------------------------------------------------------------

Sunday, Dec 1
Implemented SaveTransactionsAsync for DatabaseTransactionStorage.cs

------------------------------------------------------------------------

Monday, Dec 2
Finalized SaveTransactionsAsync for DatabaseTransactionStorage.cs.
  - Added sql-transaction with transaction object through: BeginTransaction, Commit and Rollback.
Renamed:
DatabaseManager    --> DatabaseService
TransactionManager --> TransactionService
UserService        --> UserService

 Removed IIdGenerator.cs and TransactionIdGenerator (SERIAL for now).

------------------------------------------------------------------------
Tuesday, Dec 3
Removed ITransactionOperations - Replaced by combining ITransactionStorage and TransactionService.

Refactor TransactionService to use ITransactionStorage:
  Removed:
  in-memory _transactions list.
  InitializeTransactions() as the functionality is handled by LoadTransactionsAsync().
  Fixed:
  - AddTransactionAsync()
  - RemoveTransactionAsync()
  - PrepareTransactionsAsync()
  - CalculateTotalsAsync()













------------------------------------------------------------------------
Next TODO:
Refactor TransactionService to rely on ITransactionStorage for storage. Abstract FileStorage and DatabaseStorage behind it.
 - Remove in-memory storage (list _transactions)



------------------------------------------------------------------------
TODO:
- Remove ITransactinIDGenerator?~
- Refactor the transaction storage system to prioritize 
  database storage while keeping file storage as a backup or 
  optional feature.
 - Update the flow so the program doesn't require a file to exist if 
  the database is being used.
- Check SQLTransactions ACID. Rollback()
- check out vertical slice architecture for folder/file structure
- Do I need the transactionId in Transaction.cs constructor?
- Introduce/generate UUID?